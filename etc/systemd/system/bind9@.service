############################################
# File: bind9@.service
# Path: /etc/systemd/system
#
# An instantiation of bind9.service to support
# bastion DNS hosting (multiple DNS servers on 
# multi-home gateway)
#
# PORT number must be defined in /etc/default/bind-%I
#
# This same PORT number must be declared in 'default-port' 
#    statement of 'options' section in /etc/rndc-%I.conf
#
# This same PORT number must be declared in 'listen-on' 
#    statement of 'options' section.
#
# NAMED_OPTIONS string must be defined in /etc/default/bind-%I
#    NAMED_OPTIONS cannot replace '-u' or '-c' option of 
#    named(8) for its hard-coded in this file as:
#        '-u bind -c /etc/bind/named-%I.conf'
#    Useful examples: 
#        NAMED_OPTIONS="-p 53 -s"  # open port 53/udp and write stats
#        NAMED_OPTIONS="-d 63"   # turn on various debug bit flags
#
# RNDC_OPTIONS string must be defined in /etc/default/bind-%I
#    Secured Example: RNDC_OPTIONS="-p 953 -s 127.0.0.1"
#
# References:
#   * https://bind9-users.isc.narkive.com/qECPVuuu/enable-systemd-hardening-options-for-named
#
#
#
[Unit]
Description=ISC BIND9 Domain Name Server for %I
Documentation=https://github.com/egberts/systemd-bind9/wiki
Documentation=https://bind9.readthedocs.io/
Documentation=man:named(8)
After=network.target
Wants=nss-lookup.target
Before=nss-lookup.target
AssertFileIsExecutable=/usr/sbin/named
AssertFileIsExecutable=/usr/sbin/rndc
ConditionPathExists=/run/bind/%I
ConditionPathIsDirectory=/run/bind/%I
ConditionPathIsReadWrite=/run/bind/%I
ConditionPathExists=/var/cache/bind/%I
ConditionPathIsDirectory=/var/cache/bind/%I
ConditionPathIsReadWrite=/var/cache/bind/%I
ConditionPathExists=/var/lib/bind/%I
ConditionPathIsDirectory=/var/lib/bind/%I
ConditionPathIsReadWrite=/var/lib/bind/%I

[Service]
Type=forking

# resources
###LimitNPROC=10
DeviceAllow=/dev/random r
DeviceAllow=/dev/urandom r
DeviceAllow=/dev/poll rw

# global bind9 is optional
EnvironmentFile=-/etc/default/bind9
# identifier-specific Bind environment file is required
EnvironmentFile=/etc/default/bind9-$I

CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SETGID CAP_SETUID CAP_SYS_CHROOT CAP_DAC_OVERRIDE
# File Security settings
NoNewPrivileges=true
ProtectHome=true
ProtectKernelModules=true
ProtectKernelTunables=true
ProtectControlGroups=true
# bind:bind
UMask=0007
LogsDirectoryMode=0027
LogsDirectory=/var/log/named/%I
# root:bind
ConfigurationDirectoryMode=2022

# **
# Tmpfiles
PrivateTmp=/run/bind/%I
RuntimeDirectory=/run/bind/%I
# root:bind
RuntimeDirectoryMode=0007

# Home directory
# bind:bind
WorkingDirectory=/var/cache/bind/%I

# systemd v251
# CacheDirectory=/var/cache/bind/%I
# CacheDirectoryMode=0022

# State directory (Bind9 database files, static/dynamic)
# bind:bind
StateDirectory=/var/lib/bind/%I
StateDirectoryMode=0027

PIDfile=/run/named/%I/named.pid
ExecStart=/usr/sbin/named -u bind -f -c /etc/bind/named-$I.conf $NAMED_OPTIONS

# rndc will dovetail all instantiations of Bind9 into a single rndc.conf file
# and use its `-s <server>` as a reference into the rndc.conf config file.
ExecReload=/usr/sbin/rndc -s $I $RNDC_OPTIONS -p $PORT reload
ExecStop=/usr/sbin/rndc -s $I $RNDC_OPTIONS -p $PORT stop

KillMode=process
RestartSec=5s
Restart=on-failure

[Install]
WantedBy=multi-user.target



# Additional settings for ISC bind9-users
# PrivateDevices=true
# PrivateTmp=true
# ProtectHome=true
# ProtectSystem=strict
# ProtectKernelModules=true
# ProtectKernelTunables=true
# ProtectControlGroups=true
# InaccessiblePaths=/home
# InaccessiblePaths=/opt
# InaccessiblePaths=/root
# ReadWritePaths=/run/named
# ReadWritePaths=/var/cache/bind
# ReadWritePaths=/var/lib/bind
